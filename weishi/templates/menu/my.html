<!DOCTYPE html>
<html lang="zh-CN" slick-uniqueid="3"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="format-detection" content="telephone=no">
<title>我的菜单</title>
<link rel="stylesheet" type="text/css" href="{{static_url('css/menu/canyin.css')}}">
<link rel="stylesheet" type="text/css" href="{{static_url('css/menu/dialog.css')}}">
<script src="{{static_url('js/menu/common.js')}}"></script>
<script src="{{static_url('js/menu/dialog.js')}}"></script>
<script src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.min.js"></script>
<body id="page_intelOrder" class="myOrderCon" screen_capture_injected="true">
<div class="center">
    <header>
        <span class="pCount">请叫服务员下单</span>
        <label><i>共计：</i><b class="duiqi" id="total"></b><b class="duiqi">元</b></label>
    </header>
    <section>
        <article>
            <h2>我的菜单
                <button class="btn_add emptyIt" id="clearBtn">清空</button>
                <button class="btn_add" onclick="location.href='/module/canyin/{{aid}}?i={{i}}'">+加菜</button>
            </h2>
            <ul class="myorder">
                {% for _m in my_list %}
                <li>
                    <span class="dishName">{{dish[_m.dish_id].name}}</span><i>{% if dish[_m.dish_id].special %}{{dish[_m.dish_id].special_price}}{% else %}{{dish[_m.dish_id].price}}{% end %}元/{{dish[_m.dish_id].unit}}</i>
                    <section class="bbox" dishid="{{_m.dish_id}}" dishname="{{dish[_m.dish_id].name}}">
                        <input class="btn-reduce" type="button" value="-">
                        <input class="numBox" name="numBox" type="text" value="{{_m.num}}" price="{% if dish[_m.dish_id].special %}{{dish[_m.dish_id].special_price}}{% else %}{{dish[_m.dish_id].price}}{% end %}" disabled="disabled">
                        <input type="button" class="btn-plus" value="+">
                    </section>
                </li>
                {% end %}
            </ul>
        </article>
    </section>
    <footer class="footFix">
        <a onclick="shareMenu()">分享给好友</a>
    </footer>
</div>
<script>var pageName = 'menuFilled';</script>
<script>
window.shareData = {"appid":"wxd9b153fd2a25e52f",
    "imgUrl":"http:\/\/imgcache.life.qq.com\/www\/misc\/images\/weixin_shop_logo\/3676816631_share_150_150.png",
    "timeLineLink":"http:\/\/life.qq.com\/qr\/t13623777902026#wechat_redirect",
    "tTitle":"\u5173\u6ce8\u53ef\u83b7\u5f97\u300c\u6d1e\u5ead\u571f\u83dc\u9986\u300d\u5fae\u751f\u6d3b\u4f1a\u5458\u5361",
    "tContent":"\u6d1e\u5ead\u571f\u83dc\u9986",
    "sendFriendLink":"http:\/\/life.qq.com\/qr\/f13623777902026#wechat_redirect",
    "fTitle":"\u6d1e\u5ead\u571f\u83dc\u9986",
    "fContent":"\u5173\u6ce8\u53ef\u83b7\u5f97\u300c\u6d1e\u5ead\u571f\u83dc\u9986\u300d\u5fae\u751f\u6d3b\u4f1a\u5458\u5361",
    "wContent":"#\u5fae\u4fe1\u626b\u63cf\u4e8c\u7ef4\u7801#\u6211\u521a\u5728\u6d1e\u5ead\u571f\u83dc\u9986\u626b\u63cf\u4e8c\u7ef4\u7801\uff0c\u8f7b\u677e\u83b7\u5f97\u5fae\u751f\u6d3b\u4f1a\u5458\u5361\uff0c\u5f97\u52303676816631\uff0c\u9177\u70ab\u53c8\u597d\u73a9\uff01",
    "wLink":null};
var pageName = pageName ? pageName : '';

// 分享
function shareFriend(appid, imgUrl, sendFriendLink, fContent, fTitle) {
    WeixinJSBridge.invoke('sendAppMessage',{
                            "appid":appid,
                            "img_url":imgUrl,
                            "img_width":"640",
                            "img_height":"640",
                            "link":sendFriendLink,
                            "desc":fContent,
                            "title":fTitle
                            }, function(res) {
                            _report('send_msg', res.err_msg);
                            })
}
function shareTimeline(imgUrl, timeLineLink, tContent, tTitle) {
    WeixinJSBridge.invoke('shareTimeline',{
                            "img_url":imgUrl,
                            "img_width":"640",
                            "img_height":"640",
                            "link":timeLineLink,
                            "desc": tContent,
                            "title": tTitle
                            }, function(res) {
                            _report('timeline', res.err_msg);
                            });
}
function shareWeibo(wContent, wLink) {
    WeixinJSBridge.invoke('shareWeibo',{
                            "content":wContent,
                            "url":wLink,
                            }, function(res) {
                            _report('weibo', res.err_msg);
                            });
}
// 当微信内置浏览器完成内部初始化后会触发WeixinJSBridgeReady事件。
document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {

        // 发送给好友
        WeixinJSBridge.on('menu:share:appmessage', function(argv){
            if (pageName == 'menuFilled') {

                var params = {
                    'qrcode' : qrcode,
                    'ticket' : ticket,
                    'ticketSource' : ticketSource
                };

                MLoading.show('加载中');
                setTimeout(function(){MLoading.hide();},3000);
                _doAjax('/weixin/dish/share', 'POST', params, function(ret){
                    MLoading.hide();
                    if (ret['code'] != 0) {
                        alert(ret['message']);
                        return;
                    }
                    var result = ret['result']['data'];

                    shareFriend(result.appid, result.img_url, result.link, result.desc, result.title);
                });

            } else {
                shareFriend(window.shareData.appid, window.shareData.imgUrl, window.shareData.sendFriendLink, window.shareData.fContent, window.shareData.fTitle);
            }
        });

        // 分享到朋友圈
        WeixinJSBridge.on('menu:share:timeline', function(argv){
            if (pageName == 'menuFilled') {

                var params = {
                    'qrcode' : qrcode,
                    'ticket' : ticket,
                    'ticketSource' : ticketSource
                };

                MLoading.show('加载中');
                setTimeout(function(){MLoading.hide();},3000);
                _doAjax('/weixin/dish/share', 'POST', params, function(ret){
                    MLoading.hide();
                    if (ret['code'] != 0) {
                        alert(ret['message']);
                        return;
                    }
                    var result = ret['result']['data'];

                    shareTimeline(result.img_url, result.link, result.desc, result.title);
                });

            } else {

                shareTimeline(window.shareData.imgUrl, window.shareData.timeLineLink, window.shareData.tContent, window.shareData.tTitle);
            }
        });

        // 分享到微博
        WeixinJSBridge.on('menu:share:weibo', function(argv){
            if (pageName == 'menuFilled') {

                var params = {
                    'qrcode' : qrcode,
                    'ticket' : ticket,
                    'ticketSource' : ticketSource
                };

                MLoading.show('加载中');
                setTimeout(function(){MLoading.hide();},3000);
                _doAjax('/weixin/dish/share', 'POST', params, function(ret){
                    MLoading.hide();
                    if (ret['code'] != 0) {
                        alert(ret['message']);
                        return;
                    }
                    var result = ret['result']['data'];

                    shareWeibo(result.title, result.link);
                });

            } else {

                shareWeibo(window.shareData.wContent, window.shareData.wLink);
            }
        });
     }, false)
</script>
<script type="text/javascript">
var reduce = _qAll('.btn-reduce');
var plus = _qAll('.btn-plus');
var share = _qAll('.shareBtn');
//金额累加操作
function tototal(){
    var total = 0;
    var nums = _qAll('.numBox');
    for( var j = 0; j < nums.length; j++){
        total = total + nums[j].value * nums[j].getAttribute('price');
    }
    endTotal = parseFloat(total).toFixed(2) * 100/100;
    // endTotal = endTotal == parseInt(endTotal) ? parseInt(endTotal) : endTotal;
    _q('#total').innerHTML = endTotal;
    return endTotal;
}

tototal();//初始化金额

function doSelectBtn(){
    var btn = _qAll("article ul li .bbox");
        var btnIndex = 0,btnLength = btn.length;
    for(btnIndex;btnIndex<btnLength;btnIndex++){

        var countNumText=parseInt(btn[btnIndex].children[1].value),
            btnAdd=btn[btnIndex].children[2],
            btnMin=btn[btnIndex].children[0];

        var iTimeout,iInterval,originalNum,
            beforeRemoveDish = false;

        btnAdd.addEventListener(_movestartEvt,function(){
            // alert('aaa')
            var _self = this;
            originalNum = parseInt(_self.parentNode.children[1].value, 10);
            countNumText =  originalNum +1;
            _self.parentNode.children[1].value = countNumText;
            iTimeout = setTimeout(function(){
                iInterval = setInterval(function(){
                    countNumText++;
                    _self.parentNode.children[1].value = countNumText;
                },100)
            },1000)
        });

        btnAdd.addEventListener(_moveendEvt,function(){
            //alert(countNumText)
            //_doAjax()...

            clearTimeout(iTimeout);
            clearInterval(iInterval);
            tototal();

            var _self = this;
            var countNumText =  parseInt(_self.parentNode.children[1].value, 10);
            var dishid = _self.parentNode.getAttribute('dishid');
            ajaxDishReset(dishid, countNumText, function(){}, function() {

                            _self.parentNode.children[1].value = originalNum;
                            tototal();
                         });

            // countNumText = 0;
        });

        btnMin.addEventListener(_movestartEvt,function(){
            var _self = this;
            originalNum = parseInt(_self.parentNode.children[1].value, 10);
            countNumText =  originalNum -1;

            if(countNumText <=0){
                beforeRemoveDish = true;
//                countNumText = 0;
//                _self.parentNode.children[1].value = countNumText;
            }else{
                _self.parentNode.children[1].value = countNumText;

                iTimeout = setTimeout(function(){
                    iInterval = setInterval(function(){
                        if(countNumText<=0){
                            beforeRemoveDish = true;
                            _self.parentNode.children[1].value = originalNum;
                            clearInterval(iInterval);
                            return; 
                        }
                        countNumText--;
                        _self.parentNode.children[1].value = countNumText;
                    },100)
                },1000)
            }
        })

        btnMin.addEventListener(_moveendEvt,function(){
            clearTimeout(iTimeout);
            clearInterval(iInterval);
            _self = this;

            var dishid = _self.parentNode.getAttribute('dishid');
            var dishName = _self.parentNode.getAttribute('dishName');
            var countNumText =  parseInt(_self.parentNode.children[1].value, 10);

            if(beforeRemoveDish){
                setTimeout(function(){
                    MDialog.confirm(
                        '', '是否删除' + dishName +'？', null,
                        '确定', function(){
                            ajaxDishRemove(dishid, function(){
                                                var li = _self.parentNode.parentNode;
                                                li.parentNode.removeChild(li);
                                                var total = tototal();

                                                // 没有数据后刷新页面
                                                if (total == 0) {
                                                    location.reload();
                                                }
                                            }, function() {

                                                    _self.parentNode.children[1].value = originalNum;
                                                    tototal();
                                            });

                        }, null,
                        '取消', null, null,
                        null, true, true
                    );

                },500)
                beforeRemoveDish = false;
            } else {
                tototal();
                ajaxDishRemove(dishid, countNumText, function(){}, function() {

                                _self.parentNode.children[1].value = originalNum;
                                tototal();
                            });
            }
        })
    } // for

    function ajaxDishReset(dishid, o2uNum, successCallback, errorCallback) {
        var params = {action: 'add',dish_id: dishid, i: '{{i}}'};
        _doAjax('/module/canyin/{{aid}}/dish/update', 'POST', params, function (ret) {
            successCallback();
        });
    }

    function ajaxDishRemove(dishid, successCallback, errorCallback) {
        var params = {action: 'remove',dish_id: dishid, i: '{{i}}'};
        _doAjax('/module/canyin/{{aid}}/dish/update', 'POST', params, function (ret) {
            successCallback();
        });
    } // ajaxDishRemove

} // doSelectBtn

function shareMenu(){
    var params = {'i': '{{i}}'}
    WeixinJSBridge.invoke('sendAppMessage',{
                "appid":'wxd9b153fd2a25e52f',
                "img_url":'',
                "img_width":"640",
                "img_height":"640",
                "link":'http://baidu.com',
                "desc":'这是描述',
                "title":'这是标题'
                }, function(res) {
                    if (res.err_msg == 'send_app_msg:ok' || res.err_msg == 'send_app_msg:confirm') {
                    }

     });
    /**
    setTimeout(function(){MLoading.hide();},3000);
    _doAjax('/module/canyin/{{aid}}/dish/share', 'POST', params, function(ret){
        MLoading.hide();
        if (ret['code'] != 0) {
            alert(ret['message']);
            return;
        }
        var result = ret['result']['data'];

        WeixinJSBridge.invoke('sendAppMessage',{
                "appid":result.appid,
                "img_url":result.img_url,
                "img_width":"640",
                "img_height":"640",
                "link":result.link,
                "desc":result.desc,
                "title":result.title
                }, function(res) {
                    if (res.err_msg == 'send_app_msg:ok' || res.err_msg == 'send_app_msg:confirm') {
                    }

                 });

        }); // _doAjax
     */
}

_onPageLoaded(function(){

    var reduce = _qAll('.btn-reduce');
    var plus = _qAll('.btn-plus');
    tototal();//初始化金额
    doSelectBtn();

    _q('#clearBtn').onclick = function() {

        MDialog.confirm(
            '', '是否清空菜单？', null,
            '确定', function(){
                window.location.href = "/module/canyin/{{aid}}/dish/my/remove?i={{i}}";
            }, null,
            '取消', null, null,
            null, true, true
        );

    };
});

</script>
<!--script src="http://imgcache.life.qq.com/www/misc/scripts/wei_webapp_copyright_v1.7.1.js?v=1.0.0"></script-->


</body></html>